<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            background-color: #f8f9fa;
            padding: 20px;
        }
        h2 {
            color: #333;
            margin-bottom: 20px;
        }
        .filter-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
        }
        .filter-container label {
            font-weight: bold;
        }
        .filter-container input, .filter-container select, .filter-container button {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .filter-container button {
            background-color: #007bff;
            color: white;
            cursor: pointer;
            border: none;
        }
        .table-container {
            overflow-x: auto;
        }
        table {
            width: 100%;
            min-width: 800px;
            border-collapse: collapse;
            background: white;
            box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.1);
            border-radius: 10px;
            overflow: hidden;
        }
        th, td {
            padding: 10px;
            border: 1px solid #ddd;
            text-align: center;
        }
        th {
            background-color: #007bff;
            color: white;
        }
        tr.verified {
            background-color: #d4edda; /* Light Green */
        }
        tr.unverified {
            background-color: #f8d7da; /* Light Red */
        }
        .pagination {
            margin-top: 20px;
        }
        .pagination button {
            padding: 10px;
            margin: 5px;
            border: none;
            border-radius: 5px;
            background-color: #007bff;
            color: white;
            cursor: pointer;
        }
        .pagination button:disabled {
            background-color: #ccc;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .filter-container {
                flex-direction: column;
                align-items: center;
            }
            table {
                min-width: 100%;
            }
        }
    </style>
</head>
<body>

    <h2>Donation Records</h2>

    <div class="filter-container">
        <label for="filterDate">Filter by Date:</label>
        <input type="date" id="filterDate">
        <br><br>
        <label for="filterVerified">Filter by Verification:</label>
        <select id="filterVerified">
            <option value="">All</option>
            <option value="Yes">Verified</option>
            <option value="No">Unverified</option>
        </select>
        
        <button onclick="fetchData()">Filter</button>
    </div>

    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Email</th>
                    <th>WhatsApp</th>
                    <th>Transaction ID</th>
                    <th>Amount</th>
                    <th>Date</th>
                    <th>Verified</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="donationTable"></tbody>
        </table>
    </div>

    <div class="pagination">
        <button id="prevPage" onclick="prevPage()" disabled>Previous</button>
        <span id="pageNumber">Page 1</span>
        <button id="nextPage" onclick="nextPage()" disabled>Next</button>
    </div>

    <script>
        const API_KEY = "$2a$10$KSrJlxWhmWwdb9ekq4mxg.i3ida6tgbpa1ClUt8M.OSg3eBZ4ym1y";
        const BIN_ID = "67c5357ae41b4d34e49fbc93";
        const BIN_URL = `https://api.jsonbin.io/v3/b/${BIN_ID}`;
        const BIN_URL_LATEST = `${BIN_URL}/latest`;

        let currentPage = 1;
        let rowsPerPage = 5;
        let records = [];

        async function fetchData() {
            let response = await fetch(BIN_URL_LATEST, {
                headers: { "X-Master-Key": API_KEY }
            });
            let data = await response.json();
            records = data.record || [];

            // Sort records by date (Descending Order)
            records.sort((a, b) => new Date(b.date) - new Date(a.date));

            renderTable();
        }

        function renderTable() {
            let table = document.getElementById("donationTable");
            table.innerHTML = "";

            let filterDate = document.getElementById("filterDate").value;
            let filterVerified = document.getElementById("filterVerified").value;

            let filteredRecords = records.filter(record => 
                (!filterDate || record.date === filterDate) &&
                (!filterVerified || record.verified === filterVerified)
            );

            let start = (currentPage - 1) * rowsPerPage;
            let end = start + rowsPerPage;
            let paginatedRecords = filteredRecords.slice(start, end);

            paginatedRecords.forEach(record => {
                let rowClass = record.verified === "Yes" ? "verified" : "unverified";
                let row = `<tr class="${rowClass}">
                    <td>${record.name}</td>
                    <td>${record.email}</td>
                    <td>${record.whatsapp}</td>
                    <td>${record.txnId}</td>
                    <td>â‚¹${record.amount}</td>
                    <td>${record.date}</td>
                    <td>
                        <select onchange="updateVerification('${record.txnId}', this.value)">
                            <option value="No" ${record.verified === "No" ? "selected" : ""}>No</option>
                            <option value="Yes" ${record.verified === "Yes" ? "selected" : ""}>Yes</option>
                        </select>
                    </td>
                    <td>
                        <button class="btn-whatsapp" onclick="sendWhatsApp('${record.whatsapp}', '${record.name}', '${record.amount}', '${record.txnId}', '${record.date}')">
                            Send WhatsApp
                        </button>
                    </td>
                </tr>`;
                table.innerHTML += row;
            });

            document.getElementById("pageNumber").innerText = `Page ${currentPage}`;
            document.getElementById("prevPage").disabled = currentPage === 1;
            document.getElementById("nextPage").disabled = end >= filteredRecords.length;
        }

        function nextPage() {
            currentPage++;
            renderTable();
        }

        function prevPage() {
            currentPage--;
            renderTable();
        }

        async function updateVerification(txnId, status) {
            let response = await fetch(BIN_URL_LATEST, {
                headers: { "X-Master-Key": API_KEY }
            });
            let data = await response.json();
            records = data.record.map(record => {
                if (record.txnId === txnId) {
                    record.verified = status;
                }
                return record;
            });
            await fetch(BIN_URL, {
                method: "PUT",
                headers: {
                    "Content-Type": "application/json",
                    "X-Master-Key": API_KEY
                },
                body: JSON.stringify(records)
            });
            alert("Verification status updated!");
            fetchData();
        }

        fetchData();
    </script>

</body>
</html>
